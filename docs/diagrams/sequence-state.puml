@startuml
skin rose
skinparam participantPadding 15
skinparam boxPadding 15
skinparam shadowing false
skinparam roundcorner 8

participant Client
participant "HTTP API" as API
participant "Lease Manager" as Lease
participant "Storage Crypto" as Crypto
participant "Storage Backend" as Backend
participant "Storage Change Feed" as ChangeFeed
participant "Search / Index Writer" as Index

== Acquire ==
Client -> API: POST /v1/acquire
API -> Lease: load meta, grant lease
Lease -> Crypto: encrypt updated meta
Crypto -> Backend: StoreMeta(key, expected_etag)
alt meta etag mismatch
    Backend --> Crypto: 412 meta_conflict
    Crypto --> API: conflict
    API --> Client: 409 waiting/meta_conflict
else success
    Backend --> Crypto: new_meta_etag
    Crypto --> Lease: new_meta_etag
    Lease --> API: lease_id + fencing token
    API --> Client: 200 AcquireResponse
end

== Get ==
Client -> API: POST /v1/get (X-Lease-ID)
API -> Backend: ReadState(key)
Backend --> Crypto: encrypted JSON + ETag
Crypto --> API: JSON stream + ETag
API --> Client: stream + headers

== Update ==
Client -> API: POST /v1/update (CAS headers)
API -> Crypto: compact+encrypt JSON
Crypto -> Backend: WriteState(key)
Backend --> Crypto: new_state_etag
Crypto -> Lease: update meta (version+etag)
Lease -> Crypto: encrypt meta
Crypto -> Backend: StoreMeta(..., expected_etag)
alt CAS/version conflict
    Backend --> Crypto: 412 version_conflict
    Crypto --> API: conflict
    API --> Client: 412/409 (caller retries)
else success
    Backend --> Crypto: new_meta_etag
    Crypto --> API: new version + etag
    API --> Client: 200 UpdateResponse
    Backend -> ChangeFeed: fsnotify event (namespace/key)
    ChangeFeed -> Index: enqueue ingest for key
    Index -> Crypto: read latest state (scan)
    Crypto -> Backend: ReadState(key)
    Backend --> Crypto: encrypted JSON
    Crypto --> Index: JSON + meta for segment/memtable
    Index -> Crypto: encrypt manifest/segment (if flushed)
    Crypto -> Backend: Write manifest/segment
end
== Release ==
Client -> API: POST /v1/release (X-Lease-ID)
API -> Lease: clear lease
Lease -> Crypto: encrypt meta
Crypto -> Backend: StoreMeta
Backend --> Crypto: ack
Crypto --> API: ack
API --> Client: 200 {released:true}
@enduml
