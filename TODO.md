# TODO

Priority is top-to-bottom. Each item is a larger implementation chunk with explicit test gates so we can avoid full-suite runs after every change while still isolating regressions.

- [x] P0 / Chunk 1.1: Define retry-safe write contract in `internal/storage/retry` for `WriteState`/`PutObject` (seek-and-retry when replayable, no unsafe retries when non-replayable).
- [x] P0 / Chunk 1.2: Implement retry wrapper behavior for non-replayable bodies (choose one explicit behavior and document it in code/tests: fail fast with actionable error, or single-attempt-only with no replay retries).
- [x] P0 / Chunk 1.3: Add storage retry regression tests for body replay semantics (`internal/storage/retry`): replayable reader survives transient failures; non-replayable reader is never replayed unsafely.
- [x] P0 / Chunk 1.4: Fix staged state CAS retry path in `internal/core/update` so each retry re-reads from start (rewind/recreate reader before every `StageState` attempt).
- [x] P0 / Chunk 1.5: Add core regression tests for CAS mismatch retries in staged updates (`internal/core`): payload bytes and staged metadata remain correct after at least one forced CAS retry.
- [x] P0 / Chunk 1.6: Audit write call sites affected by retry wrapper (state/object/attachment paths) and add focused guards/tests where reader replay assumptions are implicit.
- [x] P0 / Chunk 1 gate: `go test ./internal/storage/retry ./internal/core -run 'Update|Remove|Txn|Attachment'` and `./run-integration-suites.sh mem/query disk/query minio/query`. Regression focus: state/attachment truncation and CAS retry behavior.
- [ ] P0 / Chunk 2: Fix queue correctness bugs (remove `pageSize` forced-to-1 in `internal/core/queuedelivery.go`, nil-guard `result.Descriptor` in `internal/queue/dispatcher.go`, propagate caller context instead of `context.Background()` in fetch/readiness paths). Test gate: `go test ./internal/queue ./internal/core -run 'Queue|Dequeue|Dispatcher' ./internal/httpapi -run 'Queue' ./client -run 'Queue'` and `./run-integration-suites.sh mem/lq disk/lq minio/lq`. Regression focus: dequeue batching, panic safety, cancellation behavior.
- [ ] P0 / Chunk 3: Eliminate `io.Pipe` goroutine leak/deadlock risk in encrypted streaming paths (`internal/core/attachments.go`, `internal/queue/service.go` prepare/copy flows) with cancellation-aware producer shutdown. Test gate: `go test ./internal/core -run 'Attachment|Queue' ./internal/queue -run 'Payload|DLQ|copyObject'` and `./run-integration-suites.sh mem/lq disk/lq`. Regression focus: stuck goroutines, hanging uploads/dequeues.
- [ ] P1 / Chunk 4: Harden query/index control plane (`/v1/index/flush` request size limit and async in-flight cap/dedupe, scan adapter error policy so non-transient backend errors do not silently drop matches). Test gate: `go test ./internal/httpapi -run 'Index|Query' ./internal/search/... ./internal/core -run 'Query'` and `./run-integration-suites.sh mem/query disk/query minio/query`. Regression focus: query correctness and index flush stability.
- [ ] P1 / Chunk 5: Harden TC/RM endpoint handling (strict endpoint URL validation and safe path join in TC cluster fanout, txn coordinator fanout, and RM replicator request construction). Test gate: `go test ./internal/tccluster ./internal/tcclient ./internal/txncoord ./internal/tcrm ./internal/httpapi -run 'TC|RM|Fanout|Cluster'` and `./run-integration-suites.sh mixed`. Regression focus: control-plane announce/register/forward behavior.
- [ ] P1 / Chunk 6: Fix metadata/staging consistency issues (`cloneMeta` deep-copy map fields, staged object listing/discovery path logic for sweeper/recovery tooling). Test gate: `go test ./internal/core -run 'Meta|Lease|Txn' ./internal/storage/... -run 'Staging'` and `./run-integration-suites.sh mem disk minio`. Regression focus: metadata aliasing and staged artifact cleanup.
- [ ] P2 / Chunk 7: Tighten API input contracts where safe (strict JSON decode for mutating endpoints with compatibility review and targeted exceptions). Test gate: `go test ./internal/httpapi -run 'invalid_body|unknown|mutation|txn|queue|attachment' ./client -run 'CLI|Client'`. Regression focus: request validation behavior shifts.
- [ ] P2 / Chunk 8: Backfill regression guards for all above chunks (table-driven unit coverage + focused integration assertions per fix area; no full integration run per chunk). Test gate: run each chunk gate above and only then proceed.
- [ ] Release gate: run full verification once after chunks 1-8 land together (`go test ./...`, `go vet ./...`, `golint ./...`, `golangci-lint run ./...`, `./run-integration-suites.sh`).
