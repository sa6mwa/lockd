@startuml
skinparam backgroundColor transparent
skinparam shadowing false
skinparam roundcorner 8
skinparam wrapWidth 200
skinparam defaultTextAlignment center
skinparam ArrowColor #8B949E
skinparam LineColor #8B949E
skinparam packageBorderColor #8B949E
skinparam packageBackgroundColor #242A33
skinparam packageFontColor #E5E7EB
skinparam componentBorderColor #8B949E
skinparam componentFontColor #F8FAFC
skinparam databaseBorderColor #8B949E
skinparam databaseFontColor #F8FAFC

!define COLOR_CLIENT #2F3742
!define COLOR_CONTROL #343B46
!define COLOR_HTTP #3A414D
!define COLOR_SERVICE #2F3B35
!define COLOR_QUEUE #2E3646
!define COLOR_SEARCH #3B3131
!define COLOR_STORAGE #33363D

' Clients / CLI
package "Client Tier" {
  component clientSdk as "client.sdk" COLOR_CLIENT
  component clientCli as "client.cli" COLOR_CLIENT
  component cliTxn as "cli.txn (TC auth)" COLOR_CLIENT
  component cliRoot as "cli.root" COLOR_CLIENT
  component cliVerify as "cli.verify" COLOR_CLIENT
}

clientCli --> clientSdk
cliTxn --> clientSdk
cliRoot --> clientCli
cliVerify --> clientCli

' Control plane
component lsf as "control.lsf.observer" COLOR_CONTROL
component qrf as "control.qrf.controller" COLOR_CONTROL
lsf --> qrf : samples

' HTTP front door
component apiRouter as "api.http.router.*\n/api.http.server" COLOR_HTTP
component apiRouterRemote as "api.http.router.* (remote)" COLOR_HTTP
clientSdk --> apiRouter : RM endpoints
cliTxn --> apiRouter : /v1/txn/* + /v1/tc/*
qrf --> apiRouter : throttle decisions

' Transaction coordination
package "Transaction coordination" {
  component txnDecider as "txncoord.decider\n(implicit XA)" COLOR_CONTROL
  component txnApply as "txn.rm.apply\n(txn.apply + sweep)" COLOR_SERVICE
  component tcLeader as "tc.leader.manager" COLOR_CONTROL
  component tcCluster as "tc.cluster.store" COLOR_CONTROL
  component tcRMRegistry as "tc.rm.registry" COLOR_CONTROL
  component tcRMReplicator as "tc.rm.replicator" COLOR_CONTROL
}

apiRouter --> txnDecider : release/ack/nack
apiRouter --> txnApply : /v1/txn/commit|rollback|replay
txnDecider --> txnApply : local apply

txnDecider --> apiRouterRemote : fan-out /v1/txn/commit|rollback

apiRouter --> tcLeader : /v1/tc/leader + /v1/tc/lease*
apiRouter --> tcCluster : /v1/tc/join|leave|list
apiRouter --> tcRMRegistry : /v1/tc/rm/list
apiRouter --> tcRMReplicator : /v1/tc/rm/register|unregister

tcLeader --> apiRouterRemote : lease quorum
tcLeader --> tcCluster : read/write

tcRMReplicator --> tcRMRegistry : local update
tcRMReplicator --> apiRouterRemote : replicate /v1/tc/rm/*

txnApply --> tcRMRegistry : RM lookup

' Namespace/config + lifecycle
component nsConfig as "namespace.config" COLOR_SERVICE
apiRouter --> nsConfig

' Lease/state services
component leaseSvc as "server.lease.manager\nserver.lease.sweeper" COLOR_SERVICE
apiRouter --> leaseSvc
leaseSvc --> txnApply : expire pending txn

' Queue services
component queueSvc as "queue.service.meta/state" COLOR_QUEUE
component queueDispatch as "queue.dispatcher.core\n+ ready cache" COLOR_QUEUE
component changeFeed as "storage.change_feed.*" COLOR_QUEUE
apiRouter --> queueSvc
queueSvc --> queueDispatch : ready set
queueDispatch --> changeFeed : notify/watch
changeFeed --> queueDispatch : fsnotify events

' Search/index subsystem
component searchScan as "search.scan" COLOR_SEARCH
component searchIndex as "search.index" COLOR_SEARCH
apiRouter --> searchScan
apiRouter --> searchIndex
changeFeed --> searchIndex : ingest events

' Storage pipeline + backends
component snappy as "storage.pipeline.snappy.pre_encrypt" COLOR_STORAGE
component crypto as "storage.crypto.envelope" COLOR_STORAGE
component backend as "storage.backend.*" COLOR_STORAGE

component stormem as "storage.backend.mem" COLOR_STORAGE
component stordisk as "storage.backend.disk" COLOR_STORAGE
component stors3 as "storage.backend.s3/aws" COLOR_STORAGE
component storazure as "storage.backend.azure" COLOR_STORAGE

interface backendPort as " " COLOR_STORAGE

database awss3 as "AWS S3" COLOR_STORAGE
database s3compat as "S3 Compatible\n(e.g MinIO)" COLOR_STORAGE
database azureblob as "Azure Blob" COLOR_STORAGE
database disk as "Disk (native)" COLOR_STORAGE
database mem as "In-memory (native)" COLOR_STORAGE

component telemetry as "observability.telemetry.exporter" COLOR_CONTROL
component lifecycle as "server.lifecycle.core" COLOR_CONTROL
lifecycle --> apiRouter : supervise handlers
component shutdownCtl as "server.shutdown.controller" COLOR_CONTROL

leaseSvc --> snappy : state blobs
queueSvc --> snappy : queue payloads
searchScan --> snappy : state reads (scan)
searchIndex --> snappy : index segments

txnApply --> snappy : staging + decision records
tcCluster --> snappy : tc cluster members
tcRMRegistry --> snappy : rm registry

snappy --> crypto
crypto --> backend

backend -- backendPort

backendPort )-down- stormem
backendPort )-down- stordisk
backendPort )-down- stors3
backendPort )-down- storazure

stormem -- mem
stordisk -- disk
stors3 -- awss3
stors3 -- s3compat
storazure -- azureblob

lifecycle --> telemetry : export traces/metrics
shutdownCtl --> lifecycle
lifecycle --> shutdownCtl : drain signals

@enduml
