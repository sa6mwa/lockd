syntax = "proto3";

package lockd.internal;

option go_package = "pkt.systems/lockd/internal/proto;proto";

message IndexManifest {
  uint64 seq = 1;
  int64 updated_at_unix = 2;
  repeated IndexShard shards = 3;
  uint32 format_version = 4;
}

message IndexShard {
  uint32 shard_id = 1;
  repeated IndexSegmentRef segments = 2;
}

message IndexSegmentRef {
  string segment_id = 1;
  int64 created_at_unix = 2;
  uint64 doc_count = 3;
}

message IndexSegment {
  string segment_id = 1;
  int64 created_at_unix = 2;
  repeated FieldBlock fields = 3;
  repeated DocumentMeta doc_meta = 4;
  uint32 format_version = 5;
  IndexSegmentV5 v5 = 6;
}

message IndexSegmentV5 {
  repeated string doc_table = 1;
  repeated string field_dict = 2;
  repeated FieldBlockV5 fields = 3;
}

message FieldBlockV5 {
  uint32 field_id = 1;
  repeated string term_dict = 2;
  repeated PostingDocIDs postings = 3;
}

message PostingDocIDs {
  uint32 term_id = 1;
  repeated uint32 doc_ids = 2;
}

message FieldBlock {
  string name = 1;
  repeated TermPosting postings = 2;
}

message TermPosting {
  string term = 1;
  repeated string keys = 2;
}

message DocumentMeta {
  string key = 1;
  string state_etag = 2;
  int64 state_plaintext_bytes = 3;
  bytes state_descriptor = 4;
  int64 published_version = 5;
  bool query_excluded = 6;
}
